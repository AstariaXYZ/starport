// SPDX-License-Identifier: MIT
import "starport-test/StarportTest.sol";
import "starport-test/utils/Bound.sol";

contract TestFuzzStarport is StarportTest, Bound {
    function setUp() public override {
        super.setUp();

        vm.warp(100_000);
    }

    function _boundTokenByItemType(ItemType itemType) internal view override returns (address token) {
        if (itemType == ItemType.ERC20) {
            token = address(erc20s[0]);
        } else if (itemType == ItemType.ERC721) {
            token = address(erc721s[0]);
        } else if (itemType == ItemType.ERC1155) {
            token = address(erc1155s[0]);
        } else {
            revert("invalid itemType");
        }
    }

    function _issueAndApproveTarget(SpentItem[] memory what, address who, address target) internal {
        vm.startPrank(who);
        for (uint256 i = 0; i < what.length; i++) {
            if (what[i].itemType == ItemType.ERC20) {
                unchecked {
                    uint256 newSupply = TestERC20(what[i].token).totalSupply() + (what[i].amount * 2);
                    if (newSupply < TestERC20(what[i].token).totalSupply() || newSupply < what[i].amount) {
                        vm.assume(false);
                    }
                }
                TestERC20(what[i].token).mint(who, what[i].amount);
                TestERC20(what[i].token).approve(address(target), type(uint256).max);
            } else if (what[i].itemType == ItemType.ERC721) {
                TestERC721(what[i].token).mint(who, what[i].identifier);
                TestERC721(what[i].token).approve(address(target), what[i].identifier);
            } else if (what[i].itemType == ItemType.ERC1155) {
                TestERC1155(what[i].token).mint(who, what[i].identifier, what[i].amount);
                TestERC1155(what[i].token).setApprovalForAll(address(target), true);
            }
        }
        vm.stopPrank();
    }

    function boundPricingData(uint256 min) internal view returns (bytes memory pricingData) {
        BasePricing.Details memory details = BasePricing.Details({
            rate: _boundMax(min, (uint256(1e16) * 150) / (365 * 1 days)),
            carryRate: _boundMax(min, uint256((1e16 * 100)))
        });
        pricingData = abi.encode(details);
    }

    function boundStatusData() internal view returns (bytes memory statusData) {
        FixedTermStatus.Details memory boundDetails =
            FixedTermStatus.Details({loanDuration: _boundMax(1 hours, 1095 days)});
        statusData = abi.encode(boundDetails);
    }

    function boundSettlementData() internal view returns (bytes memory settlementData) {
        DutchAuctionSettlement.Details memory boundDetails = DutchAuctionSettlement.Details({
            startingPrice: _boundMax(501 ether, 1000 ether),
            endingPrice: _boundMax(1 ether, 500 ether),
            window: _boundMax(1 days, 100 days)
        });
        settlementData = abi.encode(boundDetails);
    }

    function boundFuzzLenderTerms(LoanBounds memory loanBounds) internal view returns (Starport.Terms memory terms) {
        terms.status = address(status);
        terms.settlement = address(settlement);
        terms.pricing = address(pricing);
        terms.pricingData = boundPricingData(loanBounds.minPricing);
        terms.statusData = boundStatusData();
        terms.settlementData = boundSettlementData();
    }

    struct FuzzLoan {
        address fulfiller;
        uint256 debtAmount;
        uint256 rate;
        uint256 carryRate;
        uint256 collateralLength;
        Fuzz.SpentItem[] collateral; //array of collateral
        uint8 fulfillerType;
    }

    struct FuzzRefinanceLoan {
        FuzzLoan origination;
        string refiKey;
        uint8 refiFiller;
        uint256 newRate;
        uint256 newCarryRate;
        uint256 skipTime;
    }

    struct FuzzSettleLoan {
        FuzzLoan origination;
        uint256 skipTime;
    }

    struct FuzzRepaymentLoan {
        FuzzLoan origination;
        Fuzz.SpentItem[10] repayCollateral;
        Fuzz.SpentItem[10] repayDebt;
        address[3] badAddresses;
        uint256 skipTime;
    }

    function boundFuzzLoan(FuzzLoan memory params, LoanBounds memory loanBounds)
        internal
        returns (Starport.Loan memory loan)
    {
        uint256 length = _boundMax(1, 4);
        loan.terms = boundFuzzLenderTerms(loanBounds);
        uint256 i = 0;
        if (length > params.collateral.length) {
            length = params.collateral.length;
        }
        SpentItem[] memory ret = new SpentItem[](length);

        for (; i < length; i++) {
            ret[i] = _boundSpentItem(params.collateral[i]);
        }
        loan.collateral = ret;
        SpentItem[] memory debt = new SpentItem[](1);
        debt[0] = SpentItem({
            itemType: ItemType.ERC20,
            identifier: 0,
            amount: _boundMin(params.debtAmount, type(uint128).max),
            token: address(erc20s[0])
        });
        loan.debt = debt;
        loan.borrower = borrower.addr;
        loan.custodian = SP.defaultCustodian();
        loan.issuer = lender.addr;
        return loan;
    }

    function willArithmeticOverflow(Starport.Loan memory loan) internal view returns (bool) {
        FixedTermStatus.Details memory statusDetails = abi.decode(loan.terms.statusData, (FixedTermStatus.Details));
        BasePricing.Details memory pricingDetails = abi.decode(loan.terms.pricingData, (BasePricing.Details));
        try BasePricing(loan.terms.pricing).getPaymentConsideration(loan) returns (
            SpentItem[] memory repayConsideration, SpentItem[] memory carryConsideration
        ) {
            unchecked {
                uint256 newSupply = erc20s[0].totalSupply() + repayConsideration[0].amount;
                if (newSupply < erc20s[0].totalSupply() || newSupply < repayConsideration[0].amount) {
                    return true;
                }
            }
            return false;
        } catch {
            return true;
        }
    }

    function testFuzzNewOrigination(FuzzLoan memory params) public {
        fuzzNewLoanOrigination(params, LoanBounds(0));
    }

    struct LoanBounds {
        uint256 minPricing;
    }

    function fuzzNewLoanOrigination(FuzzLoan memory params, LoanBounds memory loanBounds)
        internal
        returns (Starport.Loan memory)
    {
        vm.assume(params.collateral.length > 1);
        Starport.Loan memory loan = boundFuzzLoan(params, loanBounds);
        vm.assume(!willArithmeticOverflow(loan));

        _issueAndApproveTarget(loan.collateral, loan.borrower, address(SP));
        _issueAndApproveTarget(loan.debt, loan.issuer, address(SP));
        bytes32 borrowerSalt = _boundMinBytes32(0, type(uint256).max);
        bytes32 lenderSalt = _boundMinBytes32(0, type(uint256).max);
        address fulfiller;
        if (params.fulfillerType % 2 == 0) {
            fulfiller = loan.borrower;
        } else if (params.fulfillerType % 3 == 0) {
            fulfiller = loan.issuer;
        } else {
            fulfiller = _toAddress(_boundMin(_toUint(params.fulfiller), 100));
        }
        return newLoan(loan, borrowerSalt, lenderSalt, fulfiller);
    }

    function boundBadLoan(
        Fuzz.SpentItem[10] memory collateral,
        Fuzz.SpentItem[10] memory debt,
        address[3] memory badAddresses
    ) public returns (Starport.Loan memory loan) {
        uint256 length = _boundMin(0, collateral.length);
        loan.terms = boundFuzzLenderTerms(LoanBounds(0));
        uint256 i = 0;
        SpentItem[] memory ret = new SpentItem[](length);

        for (; i < length; i++) {
            ret[i] = _boundSpentItem(collateral[i]);
        }
        loan.collateral = ret;
        length = _boundMin(0, debt.length);
        i = 0;

        ret = new SpentItem[](length);
        for (; i < length; i++) {
            ret[i] = _boundSpentItem(debt[i]);
        }
        loan.debt = ret;
        loan.borrower = _toAddress(_boundMin(_toUint(badAddresses[0]), 100));
        loan.custodian = _toAddress(_boundMin(_toUint(badAddresses[1]), 100));
        loan.issuer = _toAddress(_boundMin(_toUint(badAddresses[2]), 100));
        return loan;
    }

    function testFuzzRepaymentFails(FuzzRepaymentLoan memory params) public {
        Starport.Loan memory badLoan = boundBadLoan(params.repayCollateral, params.repayDebt, params.badAddresses);
        Starport.Loan memory goodLoan = fuzzNewLoanOrigination(params.origination, LoanBounds(0));

        badLoan.collateral = goodLoan.collateral;
        badLoan.debt = goodLoan.debt;
        badLoan.custodian = goodLoan.custodian;
        skip(1);
        (SpentItem[] memory offer, ReceivedItem[] memory paymentConsideration) = Custodian(payable(goodLoan.custodian))
            .previewOrder(
            address(SP.seaport()),
            goodLoan.borrower,
            new SpentItem[](0),
            new SpentItem[](0),
            abi.encode(Custodian.Command(Actions.Repayment, goodLoan, ""))
        );

        OrderParameters memory op = _buildContractOrder(
            address(goodLoan.custodian), _SpentItemsToOfferItems(offer), _toConsiderationItems(paymentConsideration)
        );
        AdvancedOrder memory x = AdvancedOrder({
            parameters: op,
            numerator: 1,
            denominator: 1,
            signature: "0x",
            extraData: abi.encode(Custodian.Command(Actions.Repayment, badLoan, ""))
        });

        if (keccak256(abi.encode(goodLoan)) != keccak256(abi.encode(badLoan))) {
            vm.expectRevert();
        }
        vm.prank(badLoan.borrower);
        consideration.fulfillAdvancedOrder({
            advancedOrder: x,
            criteriaResolvers: new CriteriaResolver[](0),
            fulfillerConduitKey: bytes32(0),
            recipient: address(badLoan.borrower)
        });
    }

    function testFuzzRepaymentSuccess(FuzzRepaymentLoan memory params) public {
        Starport.Loan memory goodLoan = fuzzNewLoanOrigination(params.origination, LoanBounds(0));
        skip(_boundMax(1, abi.decode(goodLoan.terms.statusData, (FixedTermStatus.Details)).loanDuration - 1));

        (SpentItem[] memory offer, ReceivedItem[] memory paymentConsideration) = Custodian(payable(goodLoan.custodian))
            .previewOrder(
            address(SP.seaport()),
            goodLoan.borrower,
            new SpentItem[](0),
            new SpentItem[](0),
            abi.encode(Custodian.Command(Actions.Repayment, goodLoan, ""))
        );
        for (uint256 i = 0; i < paymentConsideration.length; i++) {
            erc20s[0].mint(goodLoan.borrower, paymentConsideration[i].amount);
        }

        OrderParameters memory op = _buildContractOrder(
            address(goodLoan.custodian), _SpentItemsToOfferItems(offer), _toConsiderationItems(paymentConsideration)
        );
        AdvancedOrder memory x = AdvancedOrder({
            parameters: op,
            numerator: 1,
            denominator: 1,
            signature: "0x",
            extraData: abi.encode(Custodian.Command(Actions.Repayment, goodLoan, ""))
        });

        vm.startPrank(goodLoan.borrower);
        erc20s[0].approve(address(SP.seaport()), type(uint256).max);
        consideration.fulfillAdvancedOrder({
            advancedOrder: x,
            criteriaResolvers: new CriteriaResolver[](0),
            fulfillerConduitKey: bytes32(0),
            recipient: address(goodLoan.borrower)
        });
        vm.stopPrank();
    }

    function testFuzzSettlementFails(FuzzRepaymentLoan memory params) public {
        Starport.Loan memory badLoan = boundBadLoan(params.repayCollateral, params.repayDebt, params.badAddresses);
        Starport.Loan memory goodLoan = fuzzNewLoanOrigination(params.origination, LoanBounds(0));

        badLoan.collateral = goodLoan.collateral;
        badLoan.debt = goodLoan.debt;
        badLoan.custodian = goodLoan.custodian;

        skip(
            _bound(
                params.skipTime,
                abi.decode(goodLoan.terms.statusData, (FixedTermStatus.Details)).loanDuration,
                1000 days
            )
        );

        (SpentItem[] memory offer, ReceivedItem[] memory paymentConsideration) = Custodian(payable(goodLoan.custodian))
            .previewOrder(
            address(SP.seaport()),
            goodLoan.borrower,
            new SpentItem[](0),
            new SpentItem[](0),
            abi.encode(Custodian.Command(Actions.Settlement, goodLoan, ""))
        );

        OrderParameters memory op = _buildContractOrder(
            address(goodLoan.custodian), _SpentItemsToOfferItems(offer), _toConsiderationItems(paymentConsideration)
        );
        AdvancedOrder memory x = AdvancedOrder({
            parameters: op,
            numerator: 1,
            denominator: 1,
            signature: "0x",
            extraData: abi.encode(Actions.Settlement, badLoan)
        });

        if (keccak256(abi.encode(goodLoan)) != keccak256(abi.encode(badLoan))) {
            vm.expectRevert();
        }
        vm.prank(badLoan.borrower);
        consideration.fulfillAdvancedOrder({
            advancedOrder: x,
            criteriaResolvers: new CriteriaResolver[](0),
            fulfillerConduitKey: bytes32(0),
            recipient: address(badLoan.borrower)
        });
    }

    function testFuzzSettlementSuccess(FuzzSettleLoan memory params) public {
        Starport.Loan memory goodLoan = fuzzNewLoanOrigination(params.origination, LoanBounds(0));

        address filler = _toAddress(_boundMin(_toUint(params.origination.fulfiller), 100));
        FixedTermStatus.Details memory statusDetails = abi.decode(goodLoan.terms.statusData, (FixedTermStatus.Details));

        skip(
            _bound(
                params.skipTime,
                abi.decode(goodLoan.terms.statusData, (FixedTermStatus.Details)).loanDuration,
                uint256(1000 days)
            )
        );
        (SpentItem[] memory offer, ReceivedItem[] memory paymentConsideration) = Custodian(payable(goodLoan.custodian))
            .previewOrder(
            address(SP.seaport()),
            goodLoan.borrower,
            new SpentItem[](0),
            new SpentItem[](0),
            abi.encode(Custodian.Command(Actions.Settlement, goodLoan, ""))
        );
        for (uint256 i = 0; i < paymentConsideration.length; i++) {
            erc20s[0].mint(filler, paymentConsideration[i].amount);
        }

        OrderParameters memory op = _buildContractOrder(
            address(goodLoan.custodian), _SpentItemsToOfferItems(offer), _toConsiderationItems(paymentConsideration)
        );
        AdvancedOrder memory x = AdvancedOrder({
            parameters: op,
            numerator: 1,
            denominator: 1,
            signature: "0x",
            extraData: abi.encode(Custodian.Command(Actions.Settlement, goodLoan, ""))
        });

        vm.startPrank(filler);
        erc20s[0].approve(address(SP.seaport()), type(uint256).max);
        consideration.fulfillAdvancedOrder({
            advancedOrder: x,
            criteriaResolvers: new CriteriaResolver[](0),
            fulfillerConduitKey: bytes32(0),
            recipient: address(filler)
        });
        vm.stopPrank();
    }

    //TODO: debug this counterExample for fuzz settlementSuccess
    bytes constant counterExample =
        "0x0xbddb51820000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000053ad00000000000000000000000024c20c0b0f62358b3c857a62dc3730f2daa352b60000000000000000000000029d9dc38563c32e5c2f6dc192ee70ef65f9978af30000000000000000000000000000000000000000000000000000000000002828000000000000000000000000000000000000000000000000000000000000262c0000000000000000000000000000000000000000000000000000000000002b7600000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000cb0000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000bf1f0000000000000000000000000000000000000000000000000000000000001bea0000000000000000000000000000000000000000000000000000000000005d54000000000000000000000000000000000000000000000000000000000000009d0000000000000000000000000000000000000000000000000000000000000396d084adafd9270b2c79bc55408e2ccc02e930c99eb5df667ec5e78b5401b9488c0000000000000000000000000000000000000000000000000000000000002f27000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000020b900000000000000000000000038b738f0b1cc4b349d66381e1ceeb62cef74bd9400000000000000000000000000000000000000000000000000000000000012df00000000000000000000000000000000000000000000000000000000000000290000000000000000000000000f7d06bb234527ca1a91c173b33e7ac524b0971b000000000000000000000000000000000000000000000000000000000000108b0000000000000000000000000000000000000000000000000000000000000e2800000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000079a59ce1000000000000000000000000000000000000000000000000000000000000039e00000000000000000000000000000000000000000000000000000000000004f8000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000043a20000000000000000000000000000000000000000000000000000000000001d7c0000000000000000000000000000000000000000000000000000000000000295000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000238a000000000000000000000000000000000000000000000000000000000000174a0000000000000000000000000000000000000000000000000000000000001d8e000000000000000000000000000000000000000000000000000000000000008d000000000000000000000000000000000000000000000000000000000000029a00000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000001d7400000000000000000000000000000000000000000000000000000000000000ff000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000b1cc000000000000000000000000000000000000000000000000000000000000061600000000000000000000000000000000000000000000000000000000000000e9000000000000000000000000000000000000000000000000000000000000010d0000000000000000000000000000000000000000000000000000000000002c08000000000000000000000000000000000000000000000000000000000000011c00000000000000000000000000000000000000000000000000000000000000d600000000000000000000000000000000000000000000000000000000000045ef000000000000000000000000000000000000000000000000000000000000031a0000000000000000000000000000000000000000000000000000000000003db800000000000000000000000000000000000000000000000000000000000000e10000000000000000000000000000000000000000000000000000000000002cd100000000000000000000000000000000000000000000000000000000000019190000000000000000000000000000000000000000000000000000000000000bd600000000000000000000000000000000000000000000000000000000000000dc0000000000000000000000000000000000000000000000000000000000004ab20000000000000000000000000000000000000000000000000000000003c2063b00000000000000000000000000000000000000000000000000000000226784130000000000000000000000000000000000000000000000000000000000000013000000000000000000000000000000000000000000000000000000000000004f000000000000000000000000210503c318855259983298ba58055a38d5ff63e10000000000000000000000000000000000000000000000000000000000000874000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000003a0d000000000000000000000000000000000000000000000000000000000000088e000000000000000000000000000000000000000000000000000000000000229d000000000000000000000000000000000000000000000000000000000000007400000000000000000000000000000000000000000000000000000000389a75e200000000000000000000000000000000000000000000000000000000000035ae000000000000000000000000000000000000000000000000000000004f3f865200000000000000000000000000000000000000000000000000000000000000b50000000000000000000000000000000000000000000000000000000000001ef40000000000000000000000000000000000000000000000000000000000001181000000000000000000000000000000000000000000000000000000000000398700000000000000000000000000000000000000000000000000000000000000230000000000000000000000000000000000000000000000000000000000004b3f00000000000000000000000000000000000000000000000000000000000035d20000000000000000000000000000000000000000000000000000000000000e470000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000b3ca0000000000000000000000000000000000000000000000000000000000002cbe00000000000000000000000000000000000000000000000000000000000014ec00000000000000000000000000000000000000000000000000000000000000a30000000000000000000000004c5e6a486b56a3ab4c7a78589c008b640a50b1bf0000000000000000000000004da6feb8f32416e7ad1e0795742cd64d5b8b88361164d10a556b76ddd20fb13d2e6a447e9342d33968301c22dc7f7e37480e6fe4000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000050850000000000000000000000000000000000000000000000000000000000000b670000000000000000000000000000000000000000000000000000000000002d4000000000000000000000000000000000000000000000000000000000000000e90000000000000000000000000000a0ae5cd8f016e517a87171d6d5075c2b16a100000000000000000000000087b2d08110b7d50861141d7bbdd49326af3ecb32183ab89d2b3bf6acb5c328c0f26f9448288b77a0f9e3eeb77e266dd047b4b90400000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000939792840000000000000000000000002a9e8fa175f45b235efddd97d2727741ef4eee6400000000000000000000000000000000000000000000000000000000f1bd05940000000000000000000000000000000000000000000000000000000000000053000000000000000000000000000000000000000000000000000000000000171f0000000000000000000000000000000000000000000000000000000000002e6600000000000000000000000000000000000000000000000000000000000043a1000000000000000000000000000000000000000000000000000000000000006100000000000000000000000000000000000000000000000000000000000007830000000000000000000000000000000000000000000000000000000000002306000000000000000000000000000000000000000000000000000000000000068a00000000000000000000000000000000000000000000000000000000000000a400000000000000000000000000000000000000000000000000000000000004d800000000000000000000000000000000000000000000000000000000000025d800000000000000000000000000000000000000000000000000000000000025eb00000000000000000000000000000000000000000000000000000000000000b5000000000000000000000000000000000000000000000000000000000000328a0000000000000000000000000000000000000000000000000000000000000b6600000000000000000000000000000000000000000000000000000000000001bb000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000000000000000000000000000000000000467a3ca81e33c54ebb1b902355ac3965be47263aab67238a997da36c8d4bc66950100000000000000000000000045e70d0677851eeab3cdc55022fdbd71d19538af00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000001a630000000000000000000000000000000000000000000000000000000000000bb10000000000000000000000000000000000000000000000000000000000002534000000000000000000000000000000000000000000000000000000000000009b00000000000000000000000000000000000000000000000000000000000003160000000000000000000000000000000000000000000000000000000000000e68000000000000000000000000000000000000000000000000000000000000377700000000000000000000000000000000000000000000000000000000000000e5000000000000000000000000d7331883921115e236e4c8639460256a4be65d1d000000000000000000000000000000000000000000000000000000000000291200000000000000000000000000000000000000000000000000000000000049a700000000000000000000000000000000000000000000000000000000000000ea0000000000000000000000000000000000000000000000000000000000001ff000000000000000000000000000000000000000000000000000000000000050ca0000000000000000000000000000000000000000000000000000000000003aee00000000000000000000000000000000000000000000000000000000000000980000000000000000000000000000000000000000000000000000000000000a870000000000000000000000000000000000000000000000000000000000001144000000000000000000000000000000000000000000000000000000000000bfe600000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000031e0000000000000000000000000000000000000000000000000000000000000bfc8000000000000000000000000000000000000000000000000000000006b965839000000000000000000000000000000000000000000000000000000000000006100000000000000000000000000000000000000000000000000000000000052eb00000000000000000000000000000000000000000000000000000000000006db00000000000000000000000000000000000000000000000000000000000016f900000000000000000000000000000000000000000000000000000000000000ed00000000000000000000000000000000000000000000000000000000000025a80000000000000000000000000000000000000000000000000000000000002c760000000000000000000000000000000000000000000000000000000000000e3b00000000000000000000000000000000000000000000000000000000000000470000000000000000000000000000000000000000000000000000000000000ccd000000000000000000000000575bf369f99df766be73c0ee13c11ad34a9bcbf500000000000000000000000000000000000000000000000000000000bddb5182000000000000000000000000000000000000000000000000000000000000009f0000000000000000000000000000000000000000000000000000000017a8c5260000000000000000000000000000000000000000000000000000000000000e3b0000000000000000000000000000000000000000000000000000000000001a1800000000000000000000000000000000000000000000000000000000000000510000000000000000000000000000000000000000000000000000000000001264efd9ffaa0324075a1489a35d3185ad184252d2db0c373a140788c596d10842a1000000000000000000000000000000000000000000000000000000000000518e000000000000000000000000000000000000000000000000000000000000001700000000000000000000000000000000000000000000000000000000226784140000000000000000000000000000000000000000000000000000000000005580000000000000000000000000000000000000000000000000000000000000088b000000000000000000000000000000000000000000000000000000000000005e0000000000000000000000000000000000000000000000000000002eb935ffcc000000000000000000000000000000000000000000000000000000000000523c00000000000000000000000000000000000000000000000000000000000003fa000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000019bb0000000000000000000000000000000000000000000000000000000000004ef30000000000000000000000000000000000000000000000000000000000001d3d00000000000000000000000000000000000000000000000000000000000000a10000000000000000000000000000000000000000000000000000000000001cb16661696c656400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003aae000000000000000000000000000000000000000000000000000000000000001300000000000000000000000000000000000000000000000000000000000001650955a17892103ccd3eac08b6981eaf98025cc5bb3cb191072b3ef096e87c78eb00000000000000000000000000000000000000000000000000000000a54e05bc00000000000000000000000000000000000000000000000000000000000000cb0000000000000000000000000000000000000000000000000000000000004caf0000000000000000000000000000000000000000000000000000000000002cb30000000000000000000000000000000000000000000000000000000000000f3400000000000000000000000000000000000000000000000000000000000000d8000000000000000000000000ffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000001213254937aaac9c70efc3fb24a06221cacd156706834fe3e81bbf4c9494375e2084000000000000000000000000000000000000000000000000000000000000007500000000000000000000000000000000000000000000000000000000052107d20000000000000000000000000000000000000000000000000000000000002a35000000000000000000000000000000000000000000000000000000000000077d00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000dd62ed3e0000000000000000000000000000000000000000000000000000000000000d9d0000000000000000000000000000000000000000000000000000000000003a09000000000000000000000000000000000000000000000000000000000000009900000000000000000000000000000000000000000000000000000000000021b100000000000000000000000000000000000000000000000000000000000041160000000000000000000000000000000000000000000000000000000000000af2000000000000000000000000000000000000000000000000000000000000005900000000000000000000000000000000000000000000000000000000000018a2000000000000000000000000000000000000000000000000000000000000567200000000000000000000000000000000000000000000000000000000000009a2000000000000000000000000000000000000000000000000000000000000007b00000000000000000000000000000000000000000000000000000000989197650000000000000000000000000000000000000000000000000000000000002e16000000000000000000000000000000000000000000000000000000000000083c00000000000000000000000000000000000000000000000000000000000000f90000000000000000000000000000000000000000000000000000000000003b08000000000000000000000000000000000000000000000000000000000000012d00000000000000000000000000000000000000000000000000000000000030c000000000000000000000000000000000000000000000000000000000000000d8000000000000000000000000000000000000000000000000000000000000178400000000000000000000000000000000000000000000000000000000000038f000000000000000000000000000000000000000000000000000000000582d424200000000000000000000000000000000000000000000000000000000000000ed0000000000000000000000000000000000000000000000000000000000000bf900000000000000000000000000000000000000000000000000000000000042e900000000000000000000000000000000000000000000000000000000000001f100000000000000000000000000000000000000000000000000000000000000280000000000000000000000006c00a396c3114d1d0a6d0c2cbc5405512447b2080000000000000000000000000000000000000000000000000000000000000c8c0000000000000000000000000000000000000000000000000000000000004f6d00000000000000000000000000000000000000000000000000000000000000880000000000000000000000000000000000000000000000000000000000003d0e0000000000000000000000000000000000000000000000000000000000003b940000000000000000000000000000000000000000000000000000000000000ba900000000000000000000000000000000000000000000000000000000000000f100000000000000000000000000000000000000000000000000000000000043ef0000000000000000000000000000000000000000000000000000000000000981000000000000000000000000000000000000000000000000000000000000489900000000000000000000000000000000000000000000000000000000000000d40000000000000000000000000000000000000000000000000000000000003faa0000000000000000000000000000000000000000000000000000000000002a060000000000000000000000000000000000000000000000000000000000003e2a00000000000000000000000000000000000000000000000000000000000000e8000000000000000000000000d3ee9068ac9775700798e6731a497335a4381a0700000000000000000000000000000000000000000000000000000000430008120000000000000000000000000000000000000000000000000000000000000e6f0000000000000000000000000000000000000000000000000000000000000047000000000000000000000000000000000000000000000000000000004e3f95800000000000000000000000000000000000000000000000000000000000000ced0000000000000000000000000000000000000000000000000000000000002dd100000000000000000000000000000000000000000000000000000000000000d100000000000000000000000000000000000000000000000000000000000032a60000000000000000000000000000000000000000000000000000000000002329000000000000000000000000000000000000000000000000000000000000112000000000000000000000000000000000000000000000000000000000000000730000000000000000000000000000000000000000000000000000000000002b6d17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c3000000000000000000000000000000000000000000000000000000000000002b2000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000001fb43c10000000000000000000000000000000000000000000000000000000000000bd3000000000000000000000000e86787fc637a4689319f0e5b7956eb6941381e1f0000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000298b00000000000000000000000000000000000000000000000000000000000009ab0000000000000000000000000000000000000000000000000000000000001606000000000000000000000000000000000000000000000000000000000000007d000000000000000000000000e40e82516ad42296c166065de7f812492304ff6d0000000000000000000000000000000000000000000000000000000000003aed57c66d3d85e0eb55b3720781fbd6803baef59f40ea1e66c38dd54ae65a51202d000000000000000000000000000000000000000000000000000000000000009700000000000000000000000000000000000000000000000000000000000004a60000000000000000000000000000000000000000000000000000000000003ae100000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000000000ca0000000000000000000000000000000000000000000000000000000000003aa8000000000000000000000000000000000000000000000000000000000000383b0000000000000000000000000000000000000000000000000000000000004316000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000000000000000000000000000000000000000038a2dbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1e000000000000000000000000000000000000000000000000000000000000122100000000000000000000000000000000000000000000000000000000000000bf000000000000000000000000109bdc9c9bddd95c915b999bdc98d95c9093941400000000000000000000000000000000000000000000000000000000000005fc00000000000000000000000000000000000000000000000000000000000002dc00000000000000000000000000000000000000000000000000000000000000650000000000000000000000000000000000000000000000000000000000000de3000000000000000000000000000000000000000000000000000000000000034a000000000000000000000000000000000000000000000000000000000000b73000000000000000000000000000000000000000000000000000000000000000ed0000000000000000000000009229497facfdb82f103d5d4e85c8856f7d5a27520000000000000000000000000000000000000000000000000000000000000be800000000000000000000000000000000000000000000000000000000000009b300000000000000000000000000000000000000000000000000000000000000b5000000000000000000000000000000000000000000000000000000006352211e00000000000000000000000000000000000000000000000000000000000039cf000000000000000000000000000000000000000000000000000000000000026f00000000000000000000000000000000000000000000000000000000000000f5000000000000000000000000000000000000000000000000000000000000be710000000000000000000000000000000000000000000000000000000000000f2b0000000000000000000000000000000000000000000000000000000000001e8800000000000000000000000000000000000000000000000000000000000000c50000000000000000000000000000000000000000000000000000000000001d290000000000000000000000000000000000000000000000000000000000002cf5000000000000000000000000000000000000000000000000000000000000031f000000000000000000000000000000000000000000000000000000000000006500000000000000000000000000000000000000000000000000000000000037540000000000000000000000000000000000000000000000000000000000000860000000000000000000000000000000000000000000000000000000000000081c0000000000000000000000000000000000000000000000000000000000000077000000000000000000000000000000000000000000000000000000000000194d000000000000000000000000000000000000000000000000000000000000228c0000000000000000000000000000000000000000000000000000000000005f82000000000000000000000000000000000000000000000000000000000000004600000000000000000000000000000000000000000000000000000000000019f30000000000000000000000000000000000000000000000000000000000000d6d0000000000000000000000000000000000000000000000000000000000004e0b000000000000000000000000000000000000000000000000000000000000007300000000000000000000000000000000000000000000000000000000003137b1c8894f26f396ce8c004245c8b7cd1b92103a6e4302fcbab883987149ac01b7ed0000000000000000000000000000000000000000000000000000000000009bba000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000004a530000000000000000000000000000000000000000000000000000000000003f37000000000000000000ca5cdb45aacab712450de3867b112f8894296c8e94465500000000000000000000000000000000000000000000000000000000000000b500000000000000000000000000000000000000000000000000000000000005550000000000000000000000000000000000000000000000000000000000000c140000000000000000000000000000000000000000000000000000000000004e0a000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000a32ce11f0000000000000000000000000000000000000000000000000000000000000c260000000000000000000000004b352f45589578086519b44558b381ab18cd1f9200000000000000000000000000000000000000000000000000000000000000e200000000000000000000000000000000000000000000000000000000000057fb0000000000000000000000000000000000000000000000000000000000002b130000000000000000000000000000000000000000000000000000000000000875000000000000000000000000000000000000000000000000000000000000006a000000000000000000000000000000000000000000000000000000000000151e00000000000000000000000000000000000000000000000000000000000019c10000000000000000000000000000000000000000000000000000000000002ccd00000000000000000000000000000000000000000000000000000000000000530000000000000000000000005efc7e9c9f9bd6fa83c8e85941a6fa3325ceb7fd000000000000000000000000000000000000000000000000000000000000017a00000000000000000000000000000000000000000000000000000000000005de000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000230400000000000000000000000000000000000000000000000000000000000001590000000000000000000000000000000000000000000000000000000001ffc9a800000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000215d000000000000000000000000000000000000000000000000000000000000abb6000000000000000000000000000000000000000000000000000000000000237100000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000020ef00000000000000000000000000000000000000000000000000000000000028c5000000000000000000000000000000000000000000000000000000000000075b000000000000000000000000000000000000000000000000000000000000005800000000000000000000000031eaf2183bbde62d8c05f43649cf14175ac19bd659c3f6b431a9a005091360b9bc14682fa614087dc9143114f39590b044e3783f000000000000000000000000000000010000000000000015fe0b87d35448c00000000000000000000000000000000000000000000000000000000000000000440000000000000000000000001725941da5072cc4fcc30ac4a2ce09706e8ddf000000000000000000000000000000000000000000000000000000000000002815000000000000000000000000000000000000000000000000000000000000179300000000000000000000000000000000000000000000000000000000000000710000000000000000000000000000000000000000000000000000000000000c6400000000000000000000000000000000000000000000000000000000000051a3000000000000000000000000000000000000000000000000000000000000b046000000000000000000000000000000000000000000000000000000000000009d00000000000000000000000000000000000000000000000000000000000024a900000000000000000000000000000000000000000000000000000000000012ea000000000000000000000000000000000000000000000000000000000000116d000000000000000000000000000000000000000000000000000000000000006100000000000000000000000000000000000000000000000000000000000042f00000000000000000000000000000000000000000000000000000000000000cac000000000000000000000000000000000000000000000000000000000000289a00000000000000000000000000000000000000000000000000000000000000f20000000000000000000000000000000000000000000000000000000000000b840000000000000000000000000000000000000000000000000000000000002cd500000000000000000000000000000000000000000000000000000000a900866c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001d5f00000000000000000000000000000000000000000000000000000000000015db0000000000000000000000000000000000000000000000000000000000002275000000000000000000000000000000000000000000000000000000000000009d0000000000000000000000000000000000000000000000000000000000001c5c7f33f79f85a99c3ddda1b63993233a0eceab7a7deee7c95cef48baac1fced902000000000000000000000000000000000000000000000000000000003786ddc3000000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000010be795dbd608bbd5b3927e37681ba6dd857d4b9b9ff829ea66f31e0e8d3dfebd06f0000000000000000000000000000000000000000000000000000000000000a02000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000000000000000000000000000000000000000b3a0000000000000000000000000000000000000000000000000000000000001b51000000000000000000000000000000000000000000000000000000000000002500000000000000000000000000000000000000000000000000000000000000f9000000000000000000000000000000000000000000000000000000000000018f0000000000000000000000000000000000000000000000000000000000000768000000000000000000000000000000000000000000000000000000000000169f00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000004e6400000000000000000000000000000000000000000000000000000000256929620000000000000000000000000000000000000000000000000000000000004c53000000000000000000000000000000000000000000000000000000000000008200000000000000000000000000000000000000000000000000000000000012d30000000000000000000000000000000000000000000000000000000000004f0300000000000000000000000000000000000000000000000000000000000037ed00000000000000000000000000000000000000000000000000000000000000590000000000000000000000000000000000000000000000000000000049b274ee000000000000000000000000000000000000000000000000000000000018d85b00000000000000000020c5988cd7b55499f7c2058a4596b861f5d34c8485036b00000000000000000000000000000000000000000000000000000000000000730000000000000000000000000000000000000000000000000000000000005e0f00000000000000000000000000000000000000000000000000000000000040430000000000000000000000000000000000000000000000000000000000000af80000000000000000000000000000000000000000000000000000000000000087000000000000000000000000000000000000000000000000000000000000bbe200000000000000000000000000000000000000000000000000000000000026b200000000000000000000000000000000000000000000000000000000000000d400000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000018670000000000000000000000000000000000000000000000000000000000003eea3b37b0b7091f3b57e4933fb9c02d3770ed2e36a624a451e0fabde53926215a5300000000000000000000000000000000000000000000000000000000000000b100000000000000000000000000000000000000000000000000000000000023ab000000000000000000000000000000000000000000000000000000000000b99a000000000000000000000000000000000000000000000000000000000000090700000000000000000000000000000000000000000000000000000000000000d100000000000000000000000000000000000000000000000000000000000002a300000000000000000000000000000000000000000000000000000000000036c3000000000000000000000000000000000000000000000000000000000000559000000000000000000000000000000000000000000000000000000000000000480000000000000000000000009c00f9ee7b5870ecf043d1388f4104c987721b5e000000000000000000000000000000000000000000000000000000000000529f00000000000000000000000000000000000000000000000000000000000007ef00000000000000000000000000000000000000000000000000000000000000b50000000000000000000000000000000000000000000000000000000000000c010000000000000000000000000000000000000000000000000000000000000adc000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000d70000000000000000000000000000000000000000000000000000000000003dcc000000000000000000000000000000000000000000000000000000000000253e00000000000000000000000000000000000000000000000000000000000007e900000000000000000000000000000000000000000000000000000000000000a2000000000000000000000000000000000000000000000000000000006d435421000000000000000000000000000000000000000000000000000000000000283d00000000000000000000000000000000000000000000000000000000000024aa00000000000000000000000000000000000000000000000000000000000000e10000000000000000000000000000000000000000000000000000000000003cf90000000000000000000000000000000000000000000000000000000000000cc820c4612094e9e90726376c224f7c33869c5be4b85b4e97975a5fdad4633804780000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000175f000000000000000000000000000000000000000000000000000000000000291100000000000000000000000000000000000002384773bdf1ac5676facced6091000000000000000000000000000000000000000000000000000000000000004a0000000000000000000000000000000000000000000000000000000093979284dbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1d00000000000000000000000000000000000000000000000000000000d1a57ed700000000000000000000000000000000000000000000000000000000000000e600000000000000000000000000000000000000000000000000000000000027ea0000000000000000000000000000000000000000000000000000000000000c7585bfbc23f6f0beec6efa97788fb4bfdf8c9d3e0d20ca89029e2a24c93cdc94c70000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000007ecebdff00000000000000000000000000000000000000000000000000000000000020dd00000000000000000000000000000000000000000000000000000000000016bd000000000000000000000000000000000000000000000000000000000000007b00000000000000000000000000000000000000000000000000000000000002c3000000000000000000000000000000000000000000000000000000000000148b00000000000000000000000000000000000000000000000000000000000002c40000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000e89341b0000000000000000000000000000000000000000000000000000000000001886000000000000000000000000000000000000000000000000000000000000025e00000000000000000000000000000000000000000000000000000000000000aa0000000000000000000000000000000000000000000000000000000000001e4c0000000000000000000000000000000000000000000000000000000000000c5000000000000000000000000000000000000001d3967ed30fc4f89c02bab57081000000000000000000000000000000000000000000000000000000000000003700000000000000000000000000000000000000000000000000000000000027aa000000000000000000000000000000000000000000000000000000000000077e000000000000000000000000000000000000000000000000000000000000125600000000000000000000000000000000000000000000000000000000000000510000000000000000000000000000000000000000000000000000000000000cde0000000000000000000000000000000000000000000000000000000000002be7000000000000000000000000000000000000000000000000000000000000207200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000001063000000000000000000000000000000000000000000000000000000000000046d00000000000000000000000000000000000000000000000000000000fb92699d00000000000000000000000000000000000000000000000000000000000000a30000000000000000000000000000000000000000000000000000000000002866000000000000000000000000000000000000000000000000000000000000107a00000000000000000000000000000000000000000000000000000000000024d100000000000000000000000000000000000000000000000000000000000000520000000000000000000000006b6774765670ec1060e3796802e62139d69974d9000000000000000000000000000000000000000000000000000000000000307100000000000000000000000000000000000000000000000000000000000002b200000000000000000000000000000000000000000000000000000000000000ab00000000000000000000000000000000000000000000000000000000000012b30000000000000000000000000000000000000000000000000000000000002631000000000000000000000000000000000000000000000000000000000000038300000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000002eb20000000000000000000000000000000000000000000000000000000000003de2000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000017020000000000000000000002d4cdb359361ad9b23fa47c09cd82024c40dfe9914461bca4a3a112914ee22454de01824bbfe2ba80bc790d66adeea561503060e9ad000000000000000000000000000000000000000000000000000000000000004900000000000000000000000000000000000000000000000000000000000041e2000000000000000000000000000000000000000000000000000000000000525a00000000000000000000000000000000000000000000000000000000aa9d881d000000000000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000001b9d000000000000000000000000000000000000000000000000000000000000044c00000000000000000000000000000000000000000000000000000000000010a500000000000000000000000000000000000000000000000000000000000000e8000000000000000000000000000000000000000000000000000070ab6a2f54650000000000000000000000000000000000000000000000000000000000000e8d0000000000000000000000000000000000000000000000000000000000001747000000000000000000000000000000000000000000000000000000000000000b0000000000000000000000000000000000000000000000000000000000003d9d00000cd6a0f420ee60971a4aeb3718388cbd9c17bae45920015e91dfeee1548700000000000000000000000000000000000000000000000000000000715018a700000000000000000000000000000000000000000000000000000000000000b7000000000000000000000000000000000000000000000000000000000000087d0000000000000000000000000000000000000000000000000000000000005044834e5cb0abb3aa888ddb7e9a84a76d60e9a64035daa2acd01fac6191ed218a5e00000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000005ab000000000000000000000000000000000000000000000000000000000000226000000000000000000000000000000000000000000000000000000000000000a700000000000000000000000000000000000000000000000000000000000000db0000000000000000000000000000000000000000000000000000000000000d04db3238570f90828d31f66e4c2e81096ffb17a22791e4abea5b5326064ba1769100000000000000000000000000000000000000000000000000000000000013c300000000000000000000000000000000000000000000000000000000000000cd0000000000000000000000000000000000000000000000000000000000005367000000000000000000000000000000000000000000000000000000000000335500000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000000970000000000000000000000000000000000000000000000000000000000000b581da3eed3ecef6ebaa6e5023c057ec2c75150693fd0dac5c90f4a142f9879fde900000000000000000000000000000000000001d3967ed30fc4f89c02bab57082000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000410000000000000000000000000000000000000000000000000000000000000bd80000000000000000000000000000000000000000000000000000000000003aaf00000000000000000000000000000000000000000000000000000000000000a40000000000000000000000000000000000000000000000000000000000002e440000000000000000000000000000000000000000000000000000000000000f62000000000000000000000000000000000000000000000000000000000000448e00000000000000000000000000000000000000000000000000000000000000e100000000000000000000000000000000000000000000000000000000d5da9a1c0000000000000000000000000000000000000000000000000000000000002c7700000c9a4fe172982f79f17c75c81bcf226ef9f86e3bee56711df23fa261f84b00000000000000000000000000000000000000000000000000000000000000e60000000000000000000000000000000000000000000000000000000000003d2c00000000000000000000000000000000000000000000000000000000000001f00000000000000000000000000000000000000000000000000000000000001858000000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000051f40000000000000000000000000000000000000000000000000000000000003230000000000000000000000000000000000000000000000000000000000000088b00000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000005033000000000000000000000000000000000000000000000000000000000000330d00000000000000000000000000000000000000000000000000000000000052c00000000000000000000000000000000000000000000000000000000000000027000000000000000000000000789f8605bf1ed4e704426c01f0ac7e5d9c00baed0000000000000000000000000000000000000000000000000000000000001a390000000000000000000000000000000000000000000000000000000000000857000000000000000000000000000000000000000000000000000000000000003f000000000000000000000000b3a311ee623e9a06643c56a67f4b966bba8ad83332f4e7485d6485f9f6c255929b9905c62ba919758bbe231f231eaeecf33d810b0000000000000000000000000000000000000000000000000000000000000b8b000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000039eb00000000000000000000000000000000000000000000000000000000000004cf00000000000000000000000000000000000000000000000000000000ee7d723100000000000000000000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000001ed100000000000000000000000000000000000000000000000000000000000001fe0000000000000000000000000000000000000000000000000000000000001aa500000000000000000000000000000000000000000000000000000000000000f300000000000000000000000000000000000000000000000000000000000035e7000000000000000000000000000000000000000000000000000000000000259abf67515a38ee520223d32c1266d52101c30d936ed1f3e436c8caeb0a43cb06be000000000000000000000000000000000000000000000000000000000000003f000000000000000000000000000000000000000000000000000000000000540e000000000000000000000000000000000000000000000000000000000000166100000000000000000000000000000000000000000000000000000000000016a000000000000000000000000000000000000000000000000000000000000000e900000000000000000000000000000000000000000000000000000000000017f60000000000000000000000000000000000000000000000000000000000000ede0000000000000000000000000000000000000000000000000000000000000f2c00000000000000000000000000000000000000000000000000000000000000f500000000000000000000000000000000000000000000000000000000000009cd0000000000000000000000000000000000000000000000000000000090c5013b0000000000000000000000000000000000000000000000000000000000004bd300000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000017ce00000000000000000000000000000000000000000000000000000000000030a00000000000000000000000000000000000000000000000000000000000001ed30000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000044300000000000000000000000000000000000000000000000000000000000039d600000000000000000000000000000000000000000000000000000000000012110000000000000000000000000000000000000000000000000000000000000035000000000000000000000000000000000000000000000000000000000000338d00000000000000000000000000000000000000000000000000000000bddb5182000000000000000000000000000000000000000000000000000000000000789800000000000000000000000000000000000000000000000000000000000000fa0000000000000000000000000000000000000000000000000000000000003e6df5d861c8e128201ec2c3c53dbd3cb6457cb69650fa28036baa3d4e41404c332c00000000000000000000000000000000000000000000000000000000000002ea000000000000000000000000000000000000000000000000000000000000008f0000000000000000000000005f07d72266da9702d19ffad6a514c73a89002f5f00000000000000000000000000000000000000000000000000000000000000410000000000000000000000000000000000000000000000000000000000000c46000000000000000000000000000000000000000000000000000000000000003300000000000000000000000000000000000000000000000000000000000035630000000000000000000000000000000000000000000000000000000000003210000000000000000000000000000000000000000000000000000000000000095300000000000000000000000000000000000000000000000000000000000000590000000000000000000000000000000000000000000000000000000000001a72000000000000000a09507084cc699bb0e71ea869ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000113700000000000000000000000000000000000000000000000000000000000000f3000000000000000000000000000000000000000000000000000000000000122100000000000000000000000000000000000000000000000000000000000011220000000000000000000000000000000000000000000000000000000000fdd58d00000000000000000000000000000000000000000000000000000000000000d600000000000000000000000000000000000000000000000000000000d5bfbdc500000000000000000000000000000000000000000000000000000000ea8e4eb4000000000000000000000000000000000000000000000000000000008f4eb60500000000000000000000000000000000000000000000000000000000000000cd000000000000000000000000000000000000000000000000000000000000018200000000000000000000000000000000000000000000000000000000000010dd000000000000000000000000000000000000000000000000000000000000194a000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000024f47e1a610fe3baabd85e018922c7d737e83c4a00000000000000000000000000000000000000000000000000000000000051c40000000000000000000000000000000000000000000000000000000000004cf500000000000000000000000000000000000000000000000000000000000000fe00000000000000000000000029b2a03b4a1bbce5f1cbf2b1ce10937bb872c25d0000000000000000000000000000000000000000000000000000000000002ea90000000000000000000000000000000000000000000000000000000000001f7900000000000000000000000000000000000000000000000000000000000000fb0000000000000000000000000000000000000000000000000000000000004ed10000000000000000000000000000000000000000000000000000000000000aad000000000000000000000000000000000000000000000000000000000000084a00000000000000000000000000000000000000000000000000000000000000fd000000000000000000000000000000000000000000000000000000000000351b0000000000000000000000000000000000000000000000000000000000005f01000000000000000000000000000000000000000000000000000000000000176a000000000000000000000000000000000000000000000000000000000000008c0000000000000000000000000000000000000000000000000000000000003b2400000000000000000000000000000000000000000000000000000000000004a400000000000000000000000000000000000000000000000000000000000013ad000000000000000000000000000000000000000000000000000000000000004700000000000000000000000000000000000000000000000000000000000035850000000000000000000000000000000000000000000000000000000000001abb0000000000000000000000000000000000000000000000000000000000003c93000000000000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000005711000000000000000000000000000000000000000000000000000000000000574b00000000000000000000000000000000000000000000000000000000000005eb000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000019dc0000000000000000000000000000000000000000000000000000000000002f45000000000000000000000000000000000000000000000000000000000000316d00000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000d970000000000000000000000000000000000000000000000000000000000002278000000000000000000000000000000000000000000000000000000000000294600000000000000000000000000000000000000000000000000000000000000e5000000000000000000000000ffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000037e30000000000000000000000000000000000000000000000000000000000004f3400000000000000000000000000000000000000000000000000000000000000b800000000000000000000000047c77bfba9fa4d76e918c9668547ea7474c4c8b5000000000000000000000000000000000000000000000000000000000000253d0000000000000000000000000000000000000000000000000000000000005cc2000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000036360000000000000000000000000000000000000000000000000000000000002e503c1376e627727d668f1e1fdd45a25a9766e09db9ce678606788971b4dd70f70c000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000183800000000000000000000000000000000000000000000000000000000000038eb0000000000000000000000000000000000000000000000000000000000003754000000000000000000000000000000000000000000000000000000000000003b0000000000000000000000009f2b7bc23753c7e6ce20688196489b8f5d9d7e6b00000000000000000000000000000000000000000000000000000000000026bc00000000000000000000000000000000000000000000000000000000000013500000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000255e000000000000000000000000000000000000000000000000000000000000072419fd2ff118ff40be1bbd95c7d2b1331361bd147ca4caa570cbdcbe071c513395000000000000000000000000000000000000000000000000000000000000009c0000000000000000000000000000000000000000000000000000000000005d56000000000000000000000000000000000000000000000000000000000000296b00000000000000000000000000000000000000000000000000000000000009d00000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000007fea746700000000000000000000000000000000000000000000000000000000000000ad0000000000000000000000000000000000000000000000000000000000003a810000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000350c0000000000000000000000000000000000000000000000000000000000002d1b0000000000000000000000000000000000000000000000000000000000000d0100000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000002945000000000000000000000000000000000000000000000000000000000000253d00000000000000000000000000000000000000000000000000000000000009f3000000000000000000000000000000000000000000000000000000000000003f00000000000000000000000000000000000000000000000000000000573cc5d800000000000000000000000000000000000000000000000000000000c4e8fcb60000000000000000000000000000000000000000000000000000000000000e800000000000000000000000000000000000000000000000000000000000000013000000000000000000000000000000000000000000000000000000000000188d0000000000000000000000000000000000000000000000000000000000002369000000000000000000000000000000000000000000000000000000000000442f00000000000000000000000000000000000000000000000000000000000000060000000000000000000000007e04b937eba3a0fbbd4aa447cbdede5840050a880000000000000000000000000000000000000000000000000000000079df72bd0000000000000000000000000000000000000000000000000000000000000a60000000000000000000000000000000000000000000000000000000000000005c0000000000000000000000000000000000000000000000000000000000000a7500000000000000000000000000000000000000000000000000000000000019bd00000000000000000000000000000000000000000000000000000000ee9e0e62000000000000000000000000000000000000000000000000000000000000005f0000000000000000000000000000000000000000000000000000000000002b270000000000000000000000000000000000000000000000000000000000001b7d000000000000000000000000000000000000000000000000000000000000b33f000000000000000000000000000000000000000000000000000000000000005a00000000000000000000000000000000000000000000000000000000000013d0000000000000000000000000000000000000000000000000000000000000093f000000000000000000000000000000000000000000000000000000000000782000000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000065560000000000000000000000000000000000000000000000000000000000002e700000000000000000000000000000000000000000000000000000000000001fa20000000000000000000000000000000000000000000000000000000000000056000000000000000000000000e05fcc23807536bee418f142d19fa0d21bb0cff600000000000000000000000000000000000000000000000000000000000002b300000000000000000000000000000000000000000000000000000000000002530000000000000000000000000000000000000000000000000000000000000040000000000000000000000000d68910b487aa5808b8abda3d78bc85df364b2c2f0000000000000000000000000000000000000000000000000000000000003c47000000000000000000000000000000000000000000000000000000000000145b00000000000000000000000000000000000000000000000000000000000000980000000000000000000000009247197a621a71282e87a7cbc673f3736d9aa14100000000000000000000000000000000000000000000000000000000000013ef00000000000000000000000000000000000000000000000000000000000005b900000000000000000000000000000000000000000000000000000000000000ec00000000000000000000000000000000000000000000000000000000000019640000000000000000000000000000000000000000000000000000000000004d680000000000000000000000000000000000000029508e458543d8aa4df2abee78000000000000000000000000000000000000000000000000000000000000008300000000000000000000000000000000000000000000000000000000000015c200000000000000000000000000000000000000000000000000000000000026f4000000000000000000000000000000000000000000000000000000000000279900000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000c0a00000000000000000000000000000000000000000000000000000000313ce568000000000000000000000000000000000000000000000000000000000000298b000000000000000000000000000000000000000000000000000000000000002b0000000000000000000000000000000000000000000000000000000000000e7500000000000000000000000000000000000000000000000000000000000023e50000000000000000000000000000000000000000000000000000000000000bc3000000000000000000000000000000000000000000000000000000000000009e00000000000000000000000000000000000000000000000000000000000012e7000000000000000000000000000000000000000000000000000000000000355300000000000000000000000000000000000000000000000000000000000029bf00000000000000000000000000000000000000000000000000000000000000350000000000000000000000000000000000000000000000000000000000000e980000000000000000000000000000000000000000000000000000000000003b03000000000000000000000000000000000000000000000000000000000000233f00000000000000000000000000000000000000000000000000000000000000a80000000000000000000000009bda3b06822f4fde50f6dcb0975059b6d9e9344d0000000000000000000000000000000000000000000000000000000000000bbe000000000000000000000000000000000000000000000000000000000000474100000000000000000000000000000000000000000000000000000000000000470000000000000000000000000000000000000000000000000000000000000168000000000000000000000000000000000000000000000000000000000000106146295385e04920fc192a0dcd202d9cfb51c51c90d1b9a08c4bfc68247e04622a00000000000000000000000000000000000000000000000000000000000000b300000000000000000000000000000000000000000000000000000000aa9d881d000000000000000000000000000000000000000000000000000000001e4cbc8000000000001f9b2ed8374b7ec8e5d86d963ebaff8ca8575337d47450f4d552c100000000000000000000000000000000000000000000000000000000000000f3000000000000000000000000eb3718388cbd9c17bae45920015e91dfeee154870000000000000000000000000000000000000000000000000000000000000167000000000000000000000000000000000000000000000000000000000000af9600000000000000000000000000000000000000000000000000000000000000af0000000000000000000000008cd7b55b99f7c2058a4596b861f5d34c8485036300000000000000000000000022d64619bc93c35e51617eda8f4709dca827ca180000000000000000000000000000000000000000000000000000000000001da900000000000000000000000000000000000000000000000000000000000000e80000000000000000000000000000000000000000000000000000000079a59ce2000000000000000000000000000000000000000000000000000000000000324f000000000000000000000000000000000000000000000000000000000000083e00000000000000000000000000000000000000000000000000000000000000de000000000000000000000000000000000000000000000000000000000000051a00000000000000000000000000000000000000b9a025d814b29c212b8b1a07cd0000000000000000000000000000000000000000000000000000000000000f9c000000000000000000000000000000000000000000000000000000000000009200000000000000000000000000000000000000000000000000000000000030b9dbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1e00000000000000000000000000000000000000000000000000000000000010f3000000000000000000000000000000000000000000000000000000000000003500000000000000000000000000000000000000000000d3c21bcecceda100000200000000000000000000000000000000000000000000000000000000000003ff0000000000000000000000000000000000000000000000000000000000002a87";

    //    function testCounterExample() public {
    //        address(this).call(counterExample);
    //    }

    //    function testFuzzSettlementSuccessCounter() public {
    //        (FuzzSettleLoan memory params) = abi.decode(counterExample, (FuzzSettleLoan));
    //        Starport.Loan memory goodLoan = fuzzNewLoanOrigination(params.origination, LoanBounds(0));
    //
    //        address filler = _toAddress(_boundMin(_toUint(params.origination.fulfiller), 100));
    //        FixedTermStatus.Details memory statusDetails = abi.decode(goodLoan.terms.statusData, (FixedTermStatus.Details));
    //
    //        skip(
    //            _bound(
    //                params.skipTime,
    //                abi.decode(goodLoan.terms.statusData, (FixedTermStatus.Details)).loanDuration,
    //                uint256(1000 days)
    //            )
    //        );
    //        (SpentItem[] memory offer, ReceivedItem[] memory paymentConsideration) = Custodian(payable(goodLoan.custodian))
    //            .previewOrder(
    //            address(SP.seaport()),
    //            goodLoan.borrower,
    //            new SpentItem[](0),
    //            new SpentItem[](0),
    //            abi.encode(Custodian.Command(Actions.Settlement, goodLoan, ""))
    //        );
    //        for (uint256 i = 0; i < paymentConsideration.length; i++) {
    //            erc20s[0].mint(filler, paymentConsideration[i].amount);
    //        }
    //
    //        OrderParameters memory op = _buildContractOrder(
    //            address(goodLoan.custodian), _SpentItemsToOfferItems(offer), _toConsiderationItems(paymentConsideration)
    //        );
    //        AdvancedOrder memory x = AdvancedOrder({
    //            parameters: op,
    //            numerator: 1,
    //            denominator: 1,
    //            signature: "0x",
    //            extraData: abi.encode(Custodian.Command(Actions.Settlement, goodLoan, ""))
    //        });
    //
    //        vm.startPrank(filler);
    //        erc20s[0].approve(address(SP.seaport()), type(uint256).max);
    //        consideration.fulfillAdvancedOrder({
    //            advancedOrder: x,
    //            criteriaResolvers: new CriteriaResolver[](0),
    //            fulfillerConduitKey: bytes32(0),
    //            recipient: address(filler)
    //        });
    //        vm.stopPrank();
    //    }

    function testFuzzRefinance(FuzzRefinanceLoan memory params) public {
        Starport.Loan memory goodLoan = fuzzNewLoanOrigination(params.origination, LoanBounds(1));

        uint256 oldRate = abi.decode(goodLoan.terms.pricingData, (BasePricing.Details)).rate;

        uint256 newRate = _boundMax(oldRate - 1, (uint256(1e16) * 1000) / (365 * 1 days));
        BasePricing.Details memory newPricingDetails =
            BasePricing.Details({rate: newRate, carryRate: _boundMax(0, uint256((1e16 * 100)))});
        Account memory account = makeAndAllocateAccount(params.refiKey);

        address refiFulfiller;
        skip(1);
        skip(_boundMax(params.skipTime, abi.decode(goodLoan.terms.statusData, (FixedTermStatus.Details)).loanDuration));
        (
            SpentItem[] memory considerationPayment,
            SpentItem[] memory carryPayment,
            AdditionalTransfer[] memory additionalTransfers
        ) = Pricing(goodLoan.terms.pricing).getRefinanceConsideration(
            goodLoan, abi.encode(newPricingDetails), refiFulfiller
        );
        if (params.origination.fulfillerType % 2 == 0) {
            refiFulfiller = goodLoan.borrower;
        } else if (params.origination.fulfillerType % 3 == 0) {
            refiFulfiller = account.addr;
        } else {
            refiFulfiller = _toAddress(_boundMin(params.skipTime, 100));
        }
        Starport.Loan memory goodLoan2 = goodLoan;
        LenderEnforcer.Details memory details = LenderEnforcer.Details({
            loan: SP.applyRefinanceConsiderationToLoan(
                goodLoan2, considerationPayment, carryPayment, abi.encode(newPricingDetails)
                )
        });
        _issueAndApproveTarget(details.loan.debt, account.addr, address(SP));

        details.loan.issuer = account.addr;
        details.loan.originator = address(0);
        details.loan.start = 0;

        CaveatEnforcer.SignedCaveats memory lenderCaveat = getLenderSignedCaveat({
            details: details,
            signer: account,
            salt: bytes32(0),
            enforcer: address(lenderEnforcer)
        });
        {
            if (newRate > oldRate) {
                vm.expectRevert();
            }
            vm.prank(refiFulfiller);
            SP.refinance(
                account.addr,
                refiFulfiller != account.addr ? lenderCaveat : _emptyCaveat(),
                goodLoan2,
                abi.encode(newPricingDetails)
            );
        }
    }
}
